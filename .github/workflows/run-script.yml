name: ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡
on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´22:00å‰ä¸€å¤©ï¼‰
    - cron: '0 22 * * *'
  push:
    paths:
      - 'ç¦ç”°eå®¶_Loader.py'  # å½“æ­¤è„šæœ¬æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œ

jobs:
  run-futian:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶
    env:
      TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ ‡å‡†æ—¶é—´
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # æŒ‡å®šPythonç‰ˆæœ¬
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pycryptodome
    
    - name: è·å–å½“å‰æ—¶é—´
      uses: josStorer/get-current-time@v2.0.2
      id: get-time  # ä¿®æ”¹IDä¸ºget-time
      with:
        format: YYYY-MM-DD HH:mm:ss
        utcOffset: "+08:00"
        
    - name: è°ƒè¯•ä¿¡æ¯ï¼ˆç”¨äºé—®é¢˜æ’æŸ¥ï¼‰
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "huaji_futianå˜é‡: $huaji_futian"
        echo "USERNAMEå˜é‡: $USERNAME"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: ${{ steps.get-time.outputs.formattedTime }}"
        
    - name: è¿è¡Œç¦ç”°eå®¶ç­¾åˆ°è„šæœ¬
      id: run-script
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡..."
        python ç¦ç”°eå®¶_Loader.py
        script_status=$?
        
        if [ $script_status -eq 0 ]; then
          echo "âœ… ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $script_status"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $script_status" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        # ä»GitHub Secretsè·å–æ•æ„Ÿä¿¡æ¯
        huaji_futian: ${{ secrets.HUAJI_FUTIAN }}  # å…³é”®æ·»åŠ 
      continue-on-error: true
    
    - name: ä¸Šä¼ æ—¥å¿—
      if: always()  # æ— è®ºä»»åŠ¡æˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: futian-logs-${{ steps.get-time.outputs.formattedTime }}
        path: |
          *.log
          *.txt
        retention-days: 7  # è®¾ç½®æ–‡ä»¶ä¿ç•™å¤©æ•°
        
    # ======== æ–°çš„Serveré…±é€šçŸ¥æœåŠ¡ ========
    - name: Serveré…±é€šçŸ¥
      if: always()  # ç¡®ä¿åœ¨ä»»ä½•çŠ¶æ€ä¸‹éƒ½å‘é€é€šçŸ¥
      run: |
        # è®¾ç½®å‘é€å‚æ•°
        SENDKEY="${{ secrets.SERVERCHAN_SENDKEY }}"
        TITLE=""
        DESP=""
        
        # è®¾ç½®é€šçŸ¥æ¨¡æ¿
        NOTIFICATION=$(cat <<EOF
        **ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š** ${{ steps.get-time.outputs.formattedTime }}
        **ğŸ“ ä»“åº“ï¼š** ${{ github.repository }}
        **ğŸŒ¿ åˆ†æ”¯ï¼š** ${{ github.ref_name }}
        **ğŸ”— è¿è¡Œæ—¥å¿—ï¼š** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        EOF
        )
        
        # æ ¹æ®ä¸åŒçŠ¶æ€è®¾ç½®æ¶ˆæ¯
        if [ "${{ job.status }}" == "success" ]; then
          TITLE="âœ… ç¦ç”°eå®¶ç­¾åˆ°æˆåŠŸ - ${{ steps.get-time.outputs.formattedTime }}"
          DESP="## ğŸ‰ ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ\n\n$NOTIFICATION\n**ğŸ’¬ æ¶ˆæ¯ï¼š** ${{ steps.run-script.outputs.message }}"
          
        elif [ "${{ job.status }}" == "cancelled" ]; then
          TITLE="âš ï¸ ä»»åŠ¡å–æ¶ˆ - ${{ steps.get-time.outputs.formattedTime }}"
          DESP="## ğŸš« ä»»åŠ¡æ‰§è¡Œè¢«å–æ¶ˆ\n\n$NOTIFICATION\n**ğŸ”” æç¤ºï¼š** ä»»åŠ¡è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨å–æ¶ˆ"
          
        else
          TITLE="âŒ ç¦ç”°eå®¶ç­¾åˆ°å¤±è´¥ - ${{ steps.get-time.outputs.formattedTime }}"
          DESP="## âš ï¸ ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥\n\n$NOTIFICATION\n**ğŸ’¬ é”™è¯¯ä¿¡æ¯ï¼š** ${{ steps.run-script.outputs.message || 'æœªçŸ¥é”™è¯¯' }}\n\n**ğŸ›  å¸¸è§é—®é¢˜ï¼š**\n- æ£€æŸ¥è´¦æˆ·å‡­æ®æœ‰æ•ˆæ€§\n- éªŒè¯ç½‘ç»œè¿æ¥çŠ¶æ€\n- æŸ¥çœ‹è„šæœ¬ä¾èµ–å®Œæ•´æ€§\n- ç¡®è®¤æœåŠ¡ç«¯æ¥å£å˜æ›´"
        fi
        
        # å‘é€Serveré…±é€šçŸ¥
        curl -s -X POST \
          -d "title=${TITLE}" \
          -d "desp=${DESP}" \
          "https://sctapi.ftqq.com/${SENDKEY}.send"
          
        echo "Serveré…±é€šçŸ¥å·²å‘é€ [${{ job.status }}]"
    
