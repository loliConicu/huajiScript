name: 福田e家签到任务
on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    # 每天北京时间早上6点运行（UTC时间22:00前一天）
    - cron: '0 22 * * *'
  push:
    paths:
      - '福田e家_Loader.py'  # 当此脚本更新时自动运行

jobs:
  run-futian:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 设置30分钟超时
    env:
      TZ: Asia/Shanghai  # 设置时区为中国标准时间
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # 指定Python版本
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests pycryptodome
    
    - name: 获取当前时间
      uses: josStorer/get-current-time@v2.0.2
      id: current-time
      with:
        format: YYYY-MM-DD HH:mm:ss
        utcOffset: "+08:00"
        
    - name: 调试信息（用于问题排查）
      run: |
        echo "当前工作目录: $(pwd)"
        echo "文件列表:"
        ls -la
        echo "Python版本:"
        python --version
        echo "huaji_futian变量: $huaji_futian"
        echo "USERNAME变量: $USERNAME"
        echo "当前北京时间: ${{ steps.current-time.outputs.formattedTime }}"
        
    - name: 运行福田e家签到脚本
      id: run-script
      run: |
        echo "🚀 开始执行福田e家签到任务..."
        python 福田e家_Loader.py
        script_status=$?
        
        if [ $script_status -eq 0 ]; then
          echo "✅ 福田e家签到任务执行成功"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=福田e家签到任务执行成功！" >> $GITHUB_OUTPUT
        else
          echo "❌ 福田e家签到任务执行失败，退出码: $script_status"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=福田e家签到任务执行失败，退出码: $script_status" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        # 从GitHub Secrets获取敏感信息
        huaji_futian: ${{ secrets.HUAJI_FUTIAN }}  # 关键添加
      continue-on-error: true
    
    # 成功时发送Server酱通知
    - name: 发送成功通知
      if: steps.run-script.outputs.status == 'success'
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "✅ 福田e家签到成功"
        desp: |
          ## 🎉 福田e家自动签到成功
          
          **📅 执行时间：** ${{ steps.current-time.outputs.formattedTime }}
          
          **📁 仓库：** `${{ github.repository }}`
          
          **🌿 分支：** `${{ github.ref_name }}`
          
          **✅ 状态：** 签到成功
          
          **💬 消息：** ${{ steps.run-script.outputs.message }}
          
          **🔗 查看详情：** [点击查看运行日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *福田e家自动签到任务 - 每日早上6点执行*
    
    # 失败时发送Server酱通知
    - name: 发送失败通知
      if: failure()
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "❌ 福田e家签到失败"
        desp: |
          ## ⚠️ 福田e家自动签到失败
          
          **📅 执行时间：** ${{ steps.current-time.outputs.formattedTime }}
          
          **📁 仓库：** `${{ github.repository }}`
          
          **🌿 分支：** `${{ github.ref_name }}`
          
          **❌ 状态：** 签到失败
          
          **💬 错误信息：** ${{ steps.run-script.outputs.message || '福田e家签到过程中发生未知错误' }}
          
          **🔗 查看详情：** [点击查看运行日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          **🔧 可能的原因：**
          - 网络连接问题
          - 账号信息配置错误
          - 福田e家服务异常
          - 脚本依赖问题
          
          **💡 建议操作：**
          - 检查 HUAJI_FUTIAN 密钥配置
          - 查看详细运行日志
          - 手动触发工作流测试
          
          ---
          *福田e家自动签到任务 - 请及时处理*
    
    # 超时或取消时发送通知
    - name: 发送超时/取消通知
      if: cancelled()
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "⚠️ 福田e家签到任务被取消"
        desp: |
          ## 📋 福田e家任务执行取消
          
          **📅 执行时间：** ${{ steps.current-time.outputs.formattedTime }}
          
          **📁 仓库：** `${{ github.repository }}`
          
          **⚠️ 状态：** 任务被取消或超时
          
          **🔗 查看详情：** [点击查看运行日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *福田e家自动签到任务*
        
    - name: 上传日志
      if: always()  # 无论任务成功失败都上传
      uses: actions/upload-artifact@v4
      with:
        name: futian-logs-${{ steps.current-time.outputs.formattedTime }}
        path: |
          *.log
          *.txt
        retention-days: 7  # 设置文件保留天数
