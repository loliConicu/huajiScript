name: ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡
on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´22:00å‰ä¸€å¤©ï¼‰
    - cron: '0 22 * * *'
  push:
    paths:
      - 'ç¦ç”°eå®¶_Loader.py'  # å½“æ­¤è„šæœ¬æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œ

jobs:
  run-futian:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶
    env:
      TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ ‡å‡†æ—¶é—´
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # æŒ‡å®šPythonç‰ˆæœ¬
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pycryptodome
    
    - name: è·å–å½“å‰æ—¶é—´
      uses: josStorer/get-current-time@v2.0.2
      id: current-time
      with:
        format: YYYY-MM-DD HH:mm:ss
        utcOffset: "+08:00"
        
    - name: è°ƒè¯•ä¿¡æ¯ï¼ˆç”¨äºé—®é¢˜æ’æŸ¥ï¼‰
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "Pythonç‰ˆæœ¬:"
        python --version
        echo "huaji_futianå˜é‡: $huaji_futian"
        echo "USERNAMEå˜é‡: $USERNAME"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: ${{ steps.current-time.outputs.formattedTime }}"
        
    - name: è¿è¡Œç¦ç”°eå®¶ç­¾åˆ°è„šæœ¬
      id: run-script
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡..."
        python ç¦ç”°eå®¶_Loader.py
        script_status=$?
        
        if [ $script_status -eq 0 ]; then
          echo "âœ… ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $script_status"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $script_status" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        # ä»GitHub Secretsè·å–æ•æ„Ÿä¿¡æ¯
        huaji_futian: ${{ secrets.HUAJI_FUTIAN }}  # å…³é”®æ·»åŠ 
      continue-on-error: true
    
    # æˆåŠŸæ—¶å‘é€Serveré…±é€šçŸ¥
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: steps.run-script.outputs.status == 'success'
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "âœ… ç¦ç”°eå®¶ç­¾åˆ°æˆåŠŸ"
        desp: |
          ## ğŸ‰ ç¦ç”°eå®¶è‡ªåŠ¨ç­¾åˆ°æˆåŠŸ
          
          **ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š** ${{ steps.current-time.outputs.formattedTime }}
          
          **ğŸ“ ä»“åº“ï¼š** `${{ github.repository }}`
          
          **ğŸŒ¿ åˆ†æ”¯ï¼š** `${{ github.ref_name }}`
          
          **âœ… çŠ¶æ€ï¼š** ç­¾åˆ°æˆåŠŸ
          
          **ğŸ’¬ æ¶ˆæ¯ï¼š** ${{ steps.run-script.outputs.message }}
          
          **ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š** [ç‚¹å‡»æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *ç¦ç”°eå®¶è‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡ - æ¯æ—¥æ—©ä¸Š6ç‚¹æ‰§è¡Œ*
    
    # å¤±è´¥æ—¶å‘é€Serveré…±é€šçŸ¥
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "âŒ ç¦ç”°eå®¶ç­¾åˆ°å¤±è´¥"
        desp: |
          ## âš ï¸ ç¦ç”°eå®¶è‡ªåŠ¨ç­¾åˆ°å¤±è´¥
          
          **ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š** ${{ steps.current-time.outputs.formattedTime }}
          
          **ğŸ“ ä»“åº“ï¼š** `${{ github.repository }}`
          
          **ğŸŒ¿ åˆ†æ”¯ï¼š** `${{ github.ref_name }}`
          
          **âŒ çŠ¶æ€ï¼š** ç­¾åˆ°å¤±è´¥
          
          **ğŸ’¬ é”™è¯¯ä¿¡æ¯ï¼š** ${{ steps.run-script.outputs.message || 'ç¦ç”°eå®¶ç­¾åˆ°è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯' }}
          
          **ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š** [ç‚¹å‡»æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          **ğŸ”§ å¯èƒ½çš„åŸå› ï¼š**
          - ç½‘ç»œè¿æ¥é—®é¢˜
          - è´¦å·ä¿¡æ¯é…ç½®é”™è¯¯
          - ç¦ç”°eå®¶æœåŠ¡å¼‚å¸¸
          - è„šæœ¬ä¾èµ–é—®é¢˜
          
          **ğŸ’¡ å»ºè®®æ“ä½œï¼š**
          - æ£€æŸ¥ HUAJI_FUTIAN å¯†é’¥é…ç½®
          - æŸ¥çœ‹è¯¦ç»†è¿è¡Œæ—¥å¿—
          - æ‰‹åŠ¨è§¦å‘å·¥ä½œæµæµ‹è¯•
          
          ---
          *ç¦ç”°eå®¶è‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡ - è¯·åŠæ—¶å¤„ç†*
    
    # è¶…æ—¶æˆ–å–æ¶ˆæ—¶å‘é€é€šçŸ¥
    - name: å‘é€è¶…æ—¶/å–æ¶ˆé€šçŸ¥
      if: cancelled()
      uses: easychen/github-action-server-chan@v1.0.0
      with:
        sendkey: ${{ secrets.SERVERCHAN_SENDKEY }}
        title: "âš ï¸ ç¦ç”°eå®¶ç­¾åˆ°ä»»åŠ¡è¢«å–æ¶ˆ"
        desp: |
          ## ğŸ“‹ ç¦ç”°eå®¶ä»»åŠ¡æ‰§è¡Œå–æ¶ˆ
          
          **ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š** ${{ steps.current-time.outputs.formattedTime }}
          
          **ğŸ“ ä»“åº“ï¼š** `${{ github.repository }}`
          
          **âš ï¸ çŠ¶æ€ï¼š** ä»»åŠ¡è¢«å–æ¶ˆæˆ–è¶…æ—¶
          
          **ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š** [ç‚¹å‡»æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *ç¦ç”°eå®¶è‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡*
        
    - name: ä¸Šä¼ æ—¥å¿—
      if: always()  # æ— è®ºä»»åŠ¡æˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: futian-logs-${{ steps.current-time.outputs.formattedTime }}
        path: |
          *.log
          *.txt
        retention-days: 7  # è®¾ç½®æ–‡ä»¶ä¿ç•™å¤©æ•°
